<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Ranking Lapor Subuh Bulanan</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body { font-family: Arial; background:#f4f6f8; padding:20px; }
.card { max-width:900px; margin:auto; background:#fff; padding:20px; border-radius:8px; }

label { font-weight:bold; display:block; margin-top:10px; }
select,input,button { width:100%; padding:8px; margin-top:5px; }

button {
  background:#1565c0;
  color:white;
  border:none;
  margin-top:15px;
  cursor:pointer;
}

table {
  width:100%;
  border-collapse:collapse;
  margin-top:25px;
}
th,td {
  border:1px solid #ddd;
  padding:8px;
  text-align:center;
}
th {
  background:#2e7d32;
  color:white;
}

.rank1 { background:#fff8e1; font-weight:bold; }
.rank2 { background:#f1f8e9; }
.rank3 { background:#e3f2fd; }

.belum { color:#c62828; font-style:italic; }

.section-title {
  margin-top:25px;
  font-size:18px;
  font-weight:bold;
  text-align:center;
}
</style>
</head>

<body>

<div class="card">
<h2 align="center">üèÜ Ranking Lapor Subuh Bulanan</h2>

<label>Bulan</label>
<input type="month" id="bulan">

<label>Lembaga</label>
<select id="lembaga"><option value="">Pilih</option></select>

<label>Kelas</label>
<select id="kelas"><option value="">Pilih</option></select>

<label>Rombel</label>
<select id="rombel"><option value="">Pilih</option></select>

<button onclick="loadData()">Tampilkan Ranking</button>

<div class="section-title">üèÜ Ranking Siswa</div>

<table id="rankTable" style="display:none">
<thead>
<tr>
  <th>Peringkat</th>
  <th>Nama Siswa</th>
  <th>Total Nilai</th>
</tr>
</thead>
<tbody id="rankBody"></tbody>
</table>

<div id="kosong" style="display:none;text-align:center;margin-top:15px">
‚ùå Tidak ada data
</div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getFirestore, collection, getDocs,
  query, where
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyD8SIXXPm_c-TJiaRjHbrishFtU2NICm9M",
  authDomain: "datasiswa-c10f4.firebaseapp.com",
  projectId: "datasiswa-c10f4"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const lembagaEl = document.getElementById("lembaga");
const kelasEl = document.getElementById("kelas");
const rombelEl = document.getElementById("rombel");
const rankBody = document.getElementById("rankBody");
const rankTable = document.getElementById("rankTable");
const kosong = document.getElementById("kosong");

/* LOAD LEMBAGA */
async function loadLembaga(){
  const snap = await getDocs(collection(db,"lembaga"));
  let data = [];

  snap.forEach(d=>{
    data.push({ id:d.id, nama:d.data().nama });
  });

  data.sort((a,b)=>a.nama.localeCompare(b.nama));

  data.forEach(d=>{
    lembagaEl.innerHTML += `<option value="${d.id}">${d.nama}</option>`;
  });
}

loadLembaga();

/* LOAD KELAS */
lembagaEl.onchange = async ()=>{
  kelasEl.innerHTML='<option value="">Pilih</option>';
  rombelEl.innerHTML='<option value="">Pilih</option>';

  const snap = await getDocs(
    query(collection(db,"kelas"), where("lembagaId","==",lembagaEl.value))
  );

  let data = [];
  snap.forEach(d=>{
    data.push({ id:d.id, nama:d.data().nama });
  });

  data.sort((a,b)=>a.nama.localeCompare(b.nama, 'id', {numeric:true}));

  data.forEach(d=>{
    kelasEl.innerHTML += `<option value="${d.id}">${d.nama}</option>`;
  });
};

/* LOAD ROMBEL */
kelasEl.onchange = async ()=>{
  rombelEl.innerHTML='<option value="">Pilih</option>';

  const snap = await getDocs(
    query(collection(db,"rombel"), where("kelasId","==",kelasEl.value))
  );

  let data = [];
  snap.forEach(d=>{
    data.push({ id:d.id, nama:d.data().nama });
  });

  data.sort((a,b)=>a.nama.localeCompare(b.nama, 'id', {numeric:true}));

  data.forEach(d=>{
    rombelEl.innerHTML += `<option value="${d.id}">${d.nama}</option>`;
  });
};

/* LOAD DATA */
window.loadData = async ()=>{
  rankBody.innerHTML="";
  rankTable.style.display="none";
  kosong.style.display="none";

  const bulan = document.getElementById("bulan").value;
  if(!bulan || !rombelEl.value){
    alert("Lengkapi filter");
    return;
  }

  /* ambil semua siswa rombel */
  const siswaSnap = await getDocs(
    query(collection(db,"siswa"), where("rombelId","==",rombelEl.value))
  );

  if(siswaSnap.empty){
    kosong.style.display="block";
    return;
  }

  const data = {};
  siswaSnap.forEach(s=>{
    data[s.id] = {
      nama: s.data().nama,
      total: 0
    };
  });

  /* ambil laporan bulan */
  const laporSnap = await getDocs(
    query(
      collection(db,"lapor_subuh"),
      where("bulan","==",bulan),
      where("rombelId","==",rombelEl.value)
    )
  );

  laporSnap.forEach(d=>{
    const r = d.data();
    if(data[r.siswaId]){
      data[r.siswaId].total += r.nilai;
    }
  });

  /* ranking */
  const arr = Object.values(data).sort((a,b)=>b.total-a.total);
  arr.forEach((r,i)=>{
    const cls = i==0?'rank1':i==1?'rank2':i==2?'rank3':'';
    rankBody.innerHTML+=`
      <tr class="${cls}">
        <td>${i+1}</td>
        <td>${r.nama}</td>
        <td>${r.total}</td>
      </tr>`;
  });

  rankTable.style.display="table";
};
</script>

</body>
</html>
