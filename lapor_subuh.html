<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Lapor Subuh</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      margin-top: 40px;
      background: #f4f6f8;
    }
    #jam {
      font-size: 22px;
      font-weight: bold;
      margin-bottom: 16px;
    }
    #btnSubuh {
      padding: 18px 40px;
      font-size: 20px;
      color: white;
      border: none;
      border-radius: 16px;
      cursor: pointer;
      background-color: red;
      transition: 0.3s;
    }
    #info { margin-top: 16px; font-size: 16px; }

    #formLapor {
      margin-top: 30px;
      padding: 20px;
      background: #ffffff;
      border-radius: 16px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      display: none;
    }

    select, button, input[type="file"], input[type="text"], input[type="number"] {
      padding: 12px;
      font-size: 16px;
      border-radius: 10px;
      border: 1px solid #ccc;
      margin-bottom: 15px;
      width: 80%;
      max-width: 320px;
      display: block;
      margin-left: auto;
      margin-right: auto;
      box-sizing: border-box;
    }

    #btnKirim {
      background-color: #28a745;
      color: white;
      border: none;
      cursor: pointer;
    }

    #preview, #fotoSukses {
      width: 180px;
      margin: 10px auto;
      display: none;
      border-radius: 12px;
    }

    #terimakasih {
      font-size: 18px;
      font-weight: bold;
      margin-top: 20px;
      display: none;
      color: green;
    }

    #loading {
      font-size: 14px;
      color: #666;
      margin-top: 8px;
      display: none;
    }
  </style>
</head>
<body>

<div id="jam">--:--:--</div>
<button id="btnSubuh">Lapor Subuh</button>
<div id="info"></div>
<div id="loading">Memproses...</div>

<!-- FORM -->
<div id="formLapor">
  <select id="kelas">
    <option value="">Pilih kelas</option>
    <option value="7">Kelas 7</option>
    <option value="8">Kelas 8</option>
    <option value="9">Kelas 9</option>
  </select>

  <select id="rombel" style="display:none;">
    <option value="">Pilih Rombel</option>
    <option value="A">A</option>
    <option value="B">B</option>
    <option value="C">C</option>
    <option value="D">D</option>
    <option value="E">E</option>
    <option value="F">F</option>
    <option value="G">G</option>
    <option value="H">H</option>
    <option value="I">I</option>
    <option value="J">J</option>
    <option value="K">K</option>
    <option value="L">L</option>
  </select>

  <select id="absen" style="display:none;">
    <option value="">Nomor Absen</option>
  </select>

  <input type="text" id="nama" placeholder="Tulis nama lengkap" style="display:none;">

  <input type="file" id="foto" accept="image/*" style="display:none;">
  <img id="preview">

  <button id="btnKirim" style="display:none;">Kirim</button>
</div>

<!-- HASIL -->
<img id="fotoSukses">
<div id="terimakasih"></div>

<script>
// ----- Konfigurasi -----
const API_URL = "https://script.google.com/macros/s/AKfycbz_uVs2rhV0e9omHvbzjJ8glV7NsN0QzRhY5s4YtThqhCVxcGjAHwvzUQQg35iG1BoK6w/exec"; // tetap apabila server dipakai

const btn = document.getElementById("btnSubuh");
const info = document.getElementById("info");
const jamDiv = document.getElementById("jam");

const formLapor = document.getElementById("formLapor");
const selectKelas = document.getElementById("kelas");
const selectRombel = document.getElementById("rombel");
const selectAbsen = document.getElementById("absen");
const inputNama = document.getElementById("nama");
const btnKirim = document.getElementById("btnKirim");
const inputFoto = document.getElementById("foto");
const preview = document.getElementById("preview");
const loadingDiv = document.getElementById("loading");

const fotoSukses = document.getElementById("fotoSukses");
const terimakasih = document.getElementById("terimakasih");

let sudahKirim = false;

function pad(n){ return n.toString().padStart(2,'0'); }

// Update waktu + kontrol tombol
function updateWaktu() {
  const sekarang = new Date();
  const jam = sekarang.getHours();
  const menit = sekarang.getMinutes();
  const detik = sekarang.getSeconds();
  const totalMenit = jam * 60 + menit;

  jamDiv.textContent = `Waktu sekarang: ${pad(jam)}:${pad(menit)}:${pad(detik)}`;

  // Atur rentang aktif (contoh: buka sepanjang hari kecuali bila ingin diubah)
  const mulai = 20 * 60; // 03:00
  const selesai = 23 * 60; // 05:00
  const dalamRentang = (totalMenit >= mulai && totalMenit <= selesai);

  if (dalamRentang) {
    if (sudahKirim) return;
    btn.style.backgroundColor = "blue";
    info.textContent = "✅ Lapor Subuh sedang dibuka";
    formLapor.style.display = "block";
  } else {
    btn.style.backgroundColor = "red";
    info.textContent = "⏰ Lapor Subuh aktif pukul 03.00 – 05.00";
    if (!sudahKirim) formLapor.style.display = "none";
  }
}

// Isi opsi absen 1..50
function isiAbsen() {
  let html = '<option value="">Nomor Absen</option>';
  for (let i=1;i<=50;i++) html += `<option value="${i}">${i}</option>`;
  selectAbsen.innerHTML = html;
}
isiAbsen();

// Kompres foto (sama seperti sebelumnya)
function compressImage(file, targetSizeKB = 30, maxWidth = 800) {
  return new Promise((resolve) => {
    const reader = new FileReader();
    const img = new Image();

    reader.onload = function(e) { img.src = e.target.result; };
    reader.readAsDataURL(file);

    img.onload = function() {
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');

      let width = img.width;
      let height = img.height;

      if (width > maxWidth) {
        height = Math.round((height * maxWidth) / width);
        width = maxWidth;
      }

      canvas.width = width;
      canvas.height = height;

      ctx.drawImage(img, 0, 0, width, height);

      let quality = 0.9;
      let base64 = canvas.toDataURL('image/jpeg', quality);

      while (base64.length / 1024 > targetSizeKB && quality > 0.1) {
        quality -= 0.05;
        base64 = canvas.toDataURL('image/jpeg', quality);
      }

      resolve(base64);
    };
  });
}

// Event: pilih kelas → tampilkan rombel
selectKelas.addEventListener('change', function() {
  if (!this.value) {
    selectRombel.style.display = 'none';
    selectAbsen.style.display = 'none';
    inputNama.style.display = 'none';
    inputFoto.style.display = 'none';
    btnKirim.style.display = 'none';
    preview.style.display = 'none';
    return;
  }
  selectRombel.style.display = 'block';
});

// Event: pilih rombel → tampilkan absen
selectRombel.addEventListener('change', function() {
  if (!this.value) {
    selectAbsen.style.display = 'none';
    inputNama.style.display = 'none';
    inputFoto.style.display = 'none';
    btnKirim.style.display = 'none';
    preview.style.display = 'none';
    return;
  }
  selectAbsen.style.display = 'block';
});

// Event: pilih absen → tampilkan nama input
selectAbsen.addEventListener('change', function() {
  if (!this.value) {
    inputNama.style.display = 'none';
    inputFoto.style.display = 'none';
    btnKirim.style.display = 'none';
    preview.style.display = 'none';
    return;
  }
  inputNama.style.display = 'block';
  inputFoto.style.display = 'block';
  btnKirim.style.display = 'block';
});

// Upload foto (opsional)
inputFoto.addEventListener('change', async function() {
  const file = this.files[0];
  if (!file) { preview.style.display = 'none'; return; }
  const compressed = await compressImage(file, 30);
  preview.src = compressed;
  preview.style.display = 'block';
});

// Kirim
btnKirim.addEventListener('click', function() {
  const kelas = selectKelas.value;
  const rombel = selectRombel.value;
  const absen = selectAbsen.value;
  const nama = inputNama.value.trim();

  let foto = '';
  if (preview.src && preview.src.startsWith('data:image')) foto = preview.src;

  if (!kelas || !rombel || !absen || !nama) {
    alert('Lengkapi semua kolom: kelas, rombel, absen, dan nama. Foto bersifat opsional.');
    return;
  }

  btnKirim.textContent = 'Mengirim...';
  btnKirim.disabled = true;
  loadingDiv.style.display = 'block';

  // Kirim ke server (jika ada). Jika server berbeda, ganti API_URL.
  fetch(API_URL, {
    method: 'POST',
    body: JSON.stringify({ kelas, rombel, absen, nama, foto })
  })
  .then(res => res.json())
  .then(res => {
    if (res && res.status === 'sukses') {
      sudahKirim = true;
      formLapor.style.display = 'none';

      if (foto !== '') {
        fotoSukses.src = foto;
        fotoSukses.style.display = 'block';
      }

      terimakasih.textContent = `✅ Terima kasih ${nama}, laporan terkirim`;
      terimakasih.style.display = 'block';
    } else {
      // Jika server tidak mengembalikan format yang diharapkan, tetap tampilkan sukses lokal
      sudahKirim = true;
      formLapor.style.display = 'none';
      if (foto !== '') { fotoSukses.src = foto; fotoSukses.style.display = 'block'; }
      terimakasih.textContent = `✅ Terima kasih ${nama}, laporan (lokal) terkirim`;
      terimakasih.style.display = 'block';
    }

    btnKirim.textContent = 'Kirim';
    btnKirim.disabled = false;
    loadingDiv.style.display = 'none';
  })
  .catch(err => {
    console.error(err);
    alert('Gagal mengirim — periksa koneksi atau server.');
    btnKirim.textContent = 'Kirim';
    btnKirim.disabled = false;
    loadingDiv.style.display = 'none';
  });
});

// Tombol utama juga bisa membuka form bila dalam rentang waktu aktif
btn.addEventListener('click', function() {
  // tunjukkan form jika belum terkirim dan saat aktif
  const teks = info.textContent || '';
  if (teks.includes('sedang dibuka')) {
    formLapor.style.display = 'block';
  } else {
    alert('Lapor Subuh hanya aktif pukul 03.00 - 05.00');
  }
});

// Jalankan
updateWaktu();
setInterval(updateWaktu, 1000);
</script>

</body>
</html>
