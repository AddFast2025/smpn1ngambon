<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Lapor Subuh</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body { font-family: Arial; background:#f4f6f8; padding:20px; }
.card { max-width:650px; margin:auto; background:#fff; padding:20px; border-radius:8px; }
label { font-weight:bold; display:block; margin-top:10px; }
select,input,button { width:100%; padding:8px; margin-top:5px; }
button { background:#2e7d32; color:white; border:none; margin-top:15px; cursor:pointer; }
button:disabled { background:#9e9e9e; }
.notice { background:#fff3cd; color:#856404; padding:8px; border-radius:4px; margin-top:10px; display:none; }
.error { color:#c62828; margin-top:10px; }
ul { padding-left:18px; }
hr { margin:20px 0; }
.login-btn { font-size:12px; padding:5px 12px; }
.modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.4); z-index:2000; }
.modal-box { background:#fff; width:280px; padding:15px; border-radius:8px; margin:120px auto; text-align:center; }
.modal-box input { width:100%; padding:8px; margin:10px 0; }
.modal-btn { display:flex; gap:8px; }
.modal-btn button { flex:1; padding:6px; border:none; cursor:pointer; }
.modal-btn .batal { background:#e0e0e0; color:#000; }
</style>
</head>
<body>

<!-- üîí GATE LOGIN (LAYAR PUTIH) -->
<div id="gate" style="
  position:fixed;
  inset:0;
  background:#ffffff;
  z-index:9999;
  display:flex;
  align-items:center;
  justify-content:center;
">
  <div style="
    width:280px;
    text-align:center;
    padding:20px;
    border-radius:10px;
    box-shadow:0 4px 15px rgba(0,0,0,.15);
    font-family:Arial;
  ">
    <h3>üîê Akses Sekolah</h3>
    <input type="text" id="gatePwd" placeholder="Password"
           style="width:100%;padding:10px;margin-top:10px">
    <button onclick="loginGate()"
            style="width:100%;margin-top:12px;
                   padding:10px;
                   background:#2e7d32;
                   color:#fff;border:none;border-radius:6px">
      Masuk
    </button>
    <div id="gateMsg" style="color:#c62828;margin-top:10px"></div>
  </div>
</div>

<button class="login-btn" onclick="openLogin()">üîê Admin</button>

<div id="loginModal" class="modal">
  <div class="modal-box">
    <h3>Admin</h3>
    <input type="password" id="pwdGuru" placeholder="Password">
    <div class="modal-btn">
      <button onclick="loginGuru()">Login</button>
      <button class="batal" onclick="closeLogin()">Batal</button>
    </div>
    <div id="loginStatus"></div>
  </div>
</div>

<div class="card">
<h2 align="center">Lapor Subuh</h2>

<label>Lembaga</label>
<select id="lembaga"></select>

<label>Kelas</label>
<select id="kelas"></select>

<label>Rombel</label>
<select id="rombel"></select>

<label>Nama Siswa</label>
<select id="siswa"></select>

<label>Tanggal</label>
<input type="date" id="tanggal" readonly>

<label>Pukul</label>
<input type="time" id="jam" readonly>

<label>Nilai</label>
<input value="5" readonly>

<div id="notice" class="notice"></div>
<div id="error" class="error"></div>

<label>Foto (opsional)</label>
<input type="file" id="foto" accept="image/*">
<img id="previewFoto" style="display:none; margin:12px auto; max-width:90%; border-radius:8px;">

<button onclick="kirim()">Kirim Laporan</button>

<hr>
<h3>Riwayat Siswa</h3>
<div id="history">Pilih siswa</div>

<h3>Total Nilai</h3>
<div id="total">0</div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs, query, where, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyD8SIXXPm_c-TJiaRjHbrishFtU2NICm9M",
  authDomain: "datasiswa-c10f4.firebaseapp.com",
  projectId: "datasiswa-c10f4"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* üîê PASSWORD ‚Üí LEMBAGA */
const GATE_MAP = {
  "sb": { id: "kVMG9kghdBegwrtjxbuX", nama: "SDN SIDOBANDUNG II" },
  "ngb": { id: "pPZjdvhS5UeRfGiQ4voy", nama: "SMP NEGERI 1 NGAMBON" },
  "sbtr": { id: "ybeAemUlVJhPILjcmAw2", nama: "SDN SOBONTORO II" }
};


const lembagaEl = document.getElementById("lembaga");
const kelasEl = document.getElementById("kelas");
const rombelEl = document.getElementById("rombel");
const siswaEl = document.getElementById("siswa");
const tanggalEl = document.getElementById("tanggal");
const jamEl = document.getElementById("jam");
const noticeEl = document.getElementById("notice");
const errorEl = document.getElementById("error");
const historyEl = document.getElementById("history");
const totalEl = document.getElementById("total");

function selectedText(el){
  return el.options[el.selectedIndex]?.text || "";
}

const now = new Date();
tanggalEl.value = new Date().toLocaleDateString("en-CA");
jamEl.value = now.toTimeString().slice(0,5);

/* üîì LOGIN GATE */
window.loginGate = () => {
  const pwd = document.getElementById("gatePwd").value.trim();
  const msg = document.getElementById("gateMsg");

  if (!GATE_MAP[pwd]) {
    msg.innerText = "‚ùå Password salah";
    return;
  }

  const l = GATE_MAP[pwd];
  lembagaEl.innerHTML = `<option value="${l.id}" selected>${l.nama}</option>`;
  lembagaEl.disabled = true;

  document.getElementById("gate").style.display = "none";
  lembagaEl.dispatchEvent(new Event("change"));
};







window.openLogin = ()=> document.getElementById("loginModal").style.display="block";
window.closeLogin = ()=>{ document.getElementById("loginModal").style.display="none"; document.getElementById("pwdGuru").value=""; document.getElementById("loginStatus").innerText=""; };
window.loginGuru = ()=>{
  if(document.getElementById("pwdGuru").value==="123"){
    tanggalEl.readOnly=false; jamEl.readOnly=false;
    document.getElementById("loginStatus").innerText="‚úî Login berhasil";
    setTimeout(closeLogin,700);
  } else document.getElementById("loginStatus").innerText="‚ùå Password salah";
};

async function loadLembaga(){
  lembagaEl.innerHTML="<option value=''>Pilih</option>";
  const snap = await getDocs(collection(db,"lembaga"));
  let data=[]; snap.forEach(d=>data.push({id:d.id,nama:d.data().nama}));
  data.sort((a,b)=>a.nama.localeCompare(b.nama,'id'));
  data.forEach(d=>lembagaEl.innerHTML+=`<option value="${d.id}">${d.nama}</option>`);
}
loadLembaga();

lembagaEl.onchange = async ()=>{
  kelasEl.innerHTML="<option value=''>Pilih</option>";
  rombelEl.innerHTML="<option value=''>Pilih</option>";
  siswaEl.innerHTML="<option value=''>Pilih</option>";
  const snap = await getDocs(query(collection(db,"kelas"), where("lembagaId","==",lembagaEl.value)));
  let data=[]; snap.forEach(d=>data.push({id:d.id,nama:d.data().nama}));
  data.sort((a,b)=>a.nama.localeCompare(b.nama,'id',{numeric:true}));
  data.forEach(k=>kelasEl.innerHTML+=`<option value="${k.id}">${k.nama}</option>`);
};

kelasEl.onchange = async ()=>{
  rombelEl.innerHTML="<option value=''>Pilih</option>";
  siswaEl.innerHTML="<option value=''>Pilih</option>";
  const snap = await getDocs(query(collection(db,"rombel"), where("kelasId","==",kelasEl.value)));
  let data=[]; snap.forEach(d=>data.push({id:d.id,nama:d.data().nama}));
  data.sort((a,b)=>a.nama.localeCompare(b.nama,'id',{numeric:true}));
  data.forEach(r=>rombelEl.innerHTML+=`<option value="${r.id}">${r.nama}</option>`);
};

rombelEl.onchange = async ()=>{
  siswaEl.innerHTML="<option value=''>Pilih</option>";
  const snap = await getDocs(query(collection(db,"siswa"), where("rombelId","==",rombelEl.value)));
  let data=[]; snap.forEach(d=>data.push({id:d.id,nama:d.data().nama}));
  data.sort((a,b)=>a.nama.localeCompare(b.nama,'id'));
  data.forEach(s=>siswaEl.innerHTML+=`<option value="${s.id}">${s.nama}</option>`);
};

const fotoInput = document.getElementById("foto");
const preview = document.getElementById("previewFoto");

fotoInput.addEventListener("change", () => {
  const file = fotoInput.files[0];
  if (!file) return;

  // Hanya gambar
  if (!file.type.startsWith("image/")) {
    alert("File harus berupa gambar");
    fotoInput.value = "";
    return;
  }

  const reader = new FileReader();
  reader.onload = e => {
    const img = new Image();
    img.onload = () => {
      // ukuran maksimum (px)
      const MAX_WIDTH = 200;
      const scale = Math.min(1, MAX_WIDTH / img.width);

      const canvas = document.createElement("canvas");
      canvas.width = img.width * scale;
      canvas.height = img.height * scale;

      const ctx = canvas.getContext("2d");
      ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

      // kompres (0.6 = cukup tajam tapi kecil)
      const compressedData = canvas.toDataURL("image/jpeg", 0.6);

      // tampilkan di web lokal
      preview.src = compressedData;
      preview.style.display = "block";
    };
    img.src = e.target.result;
  };
  reader.readAsDataURL(file);
});


siswaEl.onchange = loadHistory;

async function loadHistory(){
  historyEl.innerHTML="Memuat..."; totalEl.innerText="0";
  const snap = await getDocs(query(collection(db,"lapor_subuh"), where("siswaId","==",siswaEl.value)));
  let data=[]; snap.forEach(d=>data.push(d.data()));
  data.sort((a,b)=>b.tanggal.localeCompare(a.tanggal));
  let total=0, html="<ul>";
  data.forEach(r=>{ html+=`<li>${r.tanggal} ${r.jam} ‚Üí ${r.nilai}</li>`; total+=r.nilai; });
  html+="</ul>";
  historyEl.innerHTML=data.length?html:"Belum ada laporan";
  totalEl.innerText=total;
}

function validSubuh(){ return jamEl.value>="03:00" && jamEl.value<="05:00"; }

window.kirim = async ()=>{
  errorEl.innerText=""; noticeEl.style.display="none";
  if(!siswaEl.value){ errorEl.innerText="Pilih siswa"; return; }
  if(!validSubuh()){ noticeEl.innerText="‚è∞ Hanya 03.00‚Äì05.00"; noticeEl.style.display="block"; return; }

  const cek = await getDocs(query(collection(db,"lapor_subuh"), where("siswaId","==",siswaEl.value), where("tanggal","==",tanggalEl.value)));
  if(!cek.empty){ noticeEl.innerText="üôè Sudah lapor hari ini"; noticeEl.style.display="block"; return; }

  await addDoc(collection(db,"lapor_subuh"),{
    lembagaId: lembagaEl.value,
    lembagaNama: selectedText(lembagaEl),
    kelasId: kelasEl.value,
    kelasNama: selectedText(kelasEl),
    rombelId: rombelEl.value,
    rombelNama: selectedText(rombelEl),
    siswaId: siswaEl.value,
    nama: selectedText(siswaEl),
    tanggal: tanggalEl.value,
    bulan: tanggalEl.value.slice(0,7),
    jam: jamEl.value,
    nilai: 5,
    dibuat: serverTimestamp()
  });

  loadHistory();
  alert("‚úÖ Laporan berhasil");
};
</script>
</body>
</html>
